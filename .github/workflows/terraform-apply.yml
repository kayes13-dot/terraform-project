name: Terraform - Apply (main)

on:
  push:
    branches: [ "main" ]
    paths:
      - "envs/**"
      - "modules/**"
      - ".github/workflows/**"

permissions:
  contents: read
  id-token: write  # for OIDC
  actions: read

jobs:
  apply:
    runs-on: ubuntu-latest

    # OPTIONAL: require manual approval by configuring an Environment named "dev"
    environment: dev

    strategy:
      matrix:
        env: [ dev ]  # add stage/prod when ready

    defaults:
      run:
        shell: bash
        working-directory: envs/${{ matrix.env }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      # ---- Cloud auth goes here (same as PR workflow) ----
      # AWS OIDC:
      # - name: Configure AWS credentials (OIDC)
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      #     aws-region: ${{ secrets.AWS_REGION }}
      # ----------------------------------------------------

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform apply
        run: terraform apply -input=false -auto-approve
